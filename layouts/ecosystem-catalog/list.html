{{ define "main" }}
<section id="ecosystem-catalog-listing">
    <div class="row">
        <div class="col-md-3">
            <div id="filter-container"></div>
        </div>
        <div class="col-md-9">
            <div id="search-results"></div>
        </div>
    </div>
</section>

<style>
#ecosystem-catalog-listing {
    padding-top: 1.5rem;
    padding-bottom: 1.5rem;
    background: white;
    color: black;
}

.filter {
    display: block;
    font-size:1rem;
    border-bottom: 1px solid lightgray;
    border-top: 1px solid lightgray;
    padding-top: 0.2rem;
    padding-bottom: 0.4rem;
    summary {
        font-size: 1.5rem;
        line-height: 1.5rem;
        font-weight: bold;
    }

    label {
        display: block;
        font-size:1rem;
        margin-left: 1rem;
    }

    input {
        font-size: 1rem !important;
    }

    label:first-of-type {
        margin-top: 0.5rem;
    }

}

.search-result, .search-result:hover, .search-result:visited {
    text-decoration: none;
    color: black;
}

.search-results {
}

.search-result {
    display: block;
    border: 1px solid lightgray;
    padding: 1rem;
    margin-top: 0.5rem;
}

.search-result:first-of-type {
    margin-top: 0;
}

.search-result:hover {
    background: lightgray;
}

</style>
<script>

document.addEventListener("DOMContentLoaded", async function () {
    const pagefind = await import("/pagefind/pagefind.js");
    await pagefind.init();

    const filters = await pagefind.filters();



    // This function returns a string suitable for being used as an HTML id
    function sanitizeForId(...parts) {
        const sanitizedParts = parts.map((part) => {
            if (typeof part === "string") {
                return part.replace(/[^a-zA-Z0-9-_]/g, "").toLowerCase(); //Sanitize string and lowercase them
            } else if (typeof part === "number") {
                return part.toString(); // Convert numbers to strings
            } else {
                return ""; // Ignore other types I guess?
            }
        });

        const joined = sanitizedParts.join("-"); // Join with hyphens

        // Ensure the ID starts with a letter (important for CSS selectors)
        if (!/^[a-zA-Z]/.test(joined)) {
            return "id-" + joined;
        }
        return joined;
    }
    
    // Handles and displays filters
    function createFilterElements(filters, containerId) {
        const filterContainer = document.getElementById(containerId);

        //Get checkbox status and store for restoration later
        const checkedBoxIds = Array.from(
            filterContainer.querySelectorAll('input[type="checkbox"]:checked')
        ).map((checkbox) => checkbox.id);

        //Get the open / closed state of details elements and store for restoration later
        const detailsElements = filterContainer.querySelectorAll("details");
        const stateMap = {};
        detailsElements.forEach((details) => {
            stateMap[details.id] = details.open;
        });

        //Blank out the filters
        filterContainer.innerHTML = "";

        //Rebuild the filters
        for (const filterName in filters) {
            const filterValues = filters[filterName];

            const filterElement = document.createElement("details"); // Container for each filter
            filterElement.setAttribute("open", ""); //This makes the filters open by default
            filterElement.id = sanitizeForId(filterName);
            filterElement.classList.add("filter");

            const filterLabel = document.createElement("summary");
            filterLabel.textContent = filterName.replace(/-/g, " ");
            filterElement.appendChild(filterLabel);

            for (const filterValue in filterValues) {
                //Axe the empty filters
                if (`${filterValues[filterValue]}` < 1) {
                    continue;
                }

                const checkbox = document.createElement("input");
                checkbox.type = "checkbox";
                checkbox.id = sanitizeForId(filterName, filterValue);
                checkbox.name = filterName;
                checkbox.value = filterValue;
                checkbox.checked = false; // By default uncheck all filters

                const label = document.createElement("label");
                label.textContent = ` ${filterValue} (${filterValues[filterValue]})`;
                label.prepend(checkbox); // Put checkbox before the label text

                filterElement.appendChild(label);
            }

            filterContainer.appendChild(filterElement);
        }

        //Restore the checked state of filter checkboxes from the previous search
        checkedBoxIds.forEach((id) => {
            const checkbox = document.getElementById(id);
            if (checkbox) {
                checkbox.checked = true;
            }
        });

        //Restore the open/closed state of filter summaries from the previous search
        detailsElements.forEach((details) => {
            if (details.open !== true) {
                const detailsElement = document.getElementById(details.id);
                if (detailsElement) {
                    detailsElement.removeAttribute("open");
                }
            }
        });

        document
            .querySelectorAll('.filter input[type="checkbox"]')
            .forEach((checkbox) => {
                checkbox.addEventListener("change", searchWithFilters); // Trigger a search on filter change
            });
    }

    // Search and Display Results Function
    async function searchWithFilters() {
        // Get active filters from the checkboxes
        const activeFilters = {};
        const checkboxes = document.querySelectorAll(
            '.filter input[type="checkbox"]'
        );
        checkboxes.forEach((checkbox) => {
            if (checkbox.checked) {
                activeFilters[checkbox.name] =
                    activeFilters[checkbox.name] || [];
                activeFilters[checkbox.name].push(checkbox.value);
            }
        });

        const results = await pagefind.search(null, { filters: activeFilters });

        //Map the search results to make them easier to work with
        const pages = await Promise.all(results.results.map((r) => r.data()));

        // Display Search Results in a Div
        const resultsContainer = document.getElementById("search-results"); // Get your results container
        resultsContainer.innerHTML = ""; // Clear previous results
        if (pages.length > 0) {
            pages.forEach((result) => {
                title = result["meta"].title;
                image = result["meta"].image;
                const resultElement = document.createElement("a");
                resultElement.classList.add("search-result"); // Add a class for styling
                resultElement.href = result.url;
                resultElement.innerHTML = `<h3>${result.meta.title}</h3><p>${result.meta.excerpt}</p>`;
                resultsContainer.appendChild(resultElement);
            });
        } else {
            resultsContainer.innerHTML = "<p>No results found.</p>";
        }

        // Update the filters based on the new search
        const newFilters = await results.filters;
        createFilterElements(newFilters, "filter-container");
    }

    //Do a search as soon as the page loads
    searchWithFilters();
});

</script>
{{ end }}